name: Building Nitrox Pull Request

on: [push, pull_request]

jobs:
  # setup-repo:
  #   runs-on: [ubuntu-latest, windows-latest]
  #   if: github.event.pull_request.draft == false

  #   steps:
  #   - name: Checking out repository
  #     uses: actions/checkout@v2
  #     with:
  #       submodules: 'true'

  setup-linux:
    runs-on: ubuntu-latest
    # if: runner.os == 'Linux'
    steps:
    - name: Install mono
      run: |
        sudo apt update
        sudo apt install dirmngr gnupg apt-transport-https ca-certificates
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
        sudo sh -c 'echo "deb https://download.mono-project.com/repo/ubuntu stable-bionic main" > /etc/apt/sources.list.d/mono-official-stable.list'
        sudo apt update
        sudo apt install mono-complete nuget
    - name: Checking out repository
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    # TODO: depotdownloader
    # - name: Download Subnautica files (Mono)
    #   run: mono ./.github/depotDownloader/QXCTF.exe

  setup-windows:
    # needs: setup-repo
    runs-on: windows-latest
    # if: runner.os == 'Windows'
    steps:
    - name: Checking out repository
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: Download Subnautica files
      run: ./.github/depotDownloader/QXCTF.exe
    - name: Setup Nuget.exe
      uses: warrenbuckley/Setup-Nuget@v1
    - name: Restore packages
      run: nuget restore Nitrox.sln
    - name: Setup MSBuild
      uses: warrenbuckley/Setup-MSBuild@v1

  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    needs: [setup-linux, setup-windows]
    if: github.event.pull_request.draft == false

    steps:
    - name: Build with MSBuild
      run: msbuild Nitrox.sln -p:Configuration=Release
    - name: Uploading zipped launcher
      uses: actions/upload-artifact@v1
      with:
        name: release
        path: ./NitroxLauncher/bin/Release/

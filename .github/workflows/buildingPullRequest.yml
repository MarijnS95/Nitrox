name: Building Nitrox Pull Request

on: [push, pull_request]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    if: github.event.pull_request.draft == false
    steps:

    - name: Checking out repository
      uses: actions/checkout@v2
      with:
        submodules: 'true'

    ########## Ubuntu Setup ##########
    - name: Install mono
      if: runner.os == 'Linux'
      run: |
        sudo apt update
        sudo apt install dirmngr gnupg apt-transport-https ca-certificates
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
        sudo sh -c 'echo "deb https://download.mono-project.com/repo/ubuntu stable-bionic main" > /etc/apt/sources.list.d/mono-official-stable.list'
        sudo apt update
        sudo apt install mono-complete nuget

    # TODO: depotdownloader
    - uses: actions/setup-dotnet@v1
      if: runner.os == 'Linux'
    - name: Download Subnautica files (DotNet)
      if: runner.os == 'Linux'
      run: dotnet ./.github/depotDownloader/QXCTF.exe

    ########## Windows Setup ##########
    - name: Download Subnautica files
      if: runner.os == 'Windows'
      run: ./.github/depotDownloader/QXCTF.exe
    - name: Setup Nuget.exe
      if: runner.os == 'Windows'
      uses: warrenbuckley/Setup-Nuget@v1
    - name: Setup MSBuild
      if: runner.os == 'Windows'
      uses: warrenbuckley/Setup-MSBuild@v1

    ########## Run the build (cross-platform) ##########
    - name: Restore packages
      run: nuget restore Nitrox.sln
    - name: Build with MSBuild
      run: msbuild Nitrox.sln -p:Configuration=Release
    - name: Uploading zipped launcher
      uses: actions/upload-artifact@v1
      with:
        name: release
        path: ./NitroxLauncher/bin/Release/
